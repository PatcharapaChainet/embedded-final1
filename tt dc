#include <WiFi.h>      // ไลบรารีสำหรับเชื่อมต่อ WiFi
#include <MQTT.h>      // ไลบรารีสำหรับการสื่อสารแบบ MQTT

// --- ข้อมูลการเชื่อมต่อ ---
const char ssid[] = "@JumboPlusIoT";               // ชื่อ WiFi
const char pass[] = "coolpassword";            // รหัสผ่าน WiFi
const char mqtt_broker[] = "test.mosquitto.org"; // Broker ตามที่กำหนดในโค้ด
const char mqtt_client_id[] = "finally"; // ID อุปกรณ์

// --- Topics สำหรับ MQTT Dashboard (ตามโจทย์ข้อ 4) ---
const char mqtt_ldr[]    = "group14/dc/ldr";    // 4.1 แสดงค่าที่อ่านได้จากเซนเซอร์แสง
const char mqtt_status[] = "group14/dc/status"; // 4.2 แสดงสถานะ Clockwise, Counter Clockwise, Stop

// --- กำหนดขา Pin ---
#define LDR_PIN 32   // ขาต่อเซนเซอร์แสง LDR
#define IN1     23   // ขาควบคุม H-Bridge ช่องที่ 1
#define IN2     22   // ขาควบคุม H-Bridge ช่องที่ 2

WiFiClient net;
MQTTClient client;

void connect() {
  Serial.print("Connecting...");
  while (WiFi.status() != WL_CONNECTED) { delay(500); } // รอการเชื่อมต่อ WiFi
  while (!client.connect(mqtt_client_id)) { delay(500); } // รอการเชื่อมต่อ MQTT
  Serial.println("Connected!");
}

void setup() {
  Serial.begin(9600);
  pinMode(IN1, OUTPUT); // ตั้งค่าขา H-Bridge เป็น Output
  pinMode(IN2, OUTPUT);
  
  // *** โจทย์ข้อ 3.1: เริ่มต้นให้มอเตอร์หยุดหมุน ***
  digitalWrite(IN1, LOW); 
  digitalWrite(IN2, LOW); 

  WiFi.begin(ssid, pass);
  client.begin(mqtt_broker, net);
  connect();
}

void loop() {
  client.loop();
  if (!client.connected()) connect();

  // อ่านค่าจาก LDR และแปลงเป็นช่วง 0-1023 ตามโจทย์ (ข้อ 3.2)
  int raw_ldr = analogRead(LDR_PIN);
  int ldr_adc = map(raw_ldr, 0, 4095, 0, 1023); 
  
  String motorStatus = "";

  // *** โจทย์ข้อ 3.2 และ 3.3: เงื่อนไขการหมุนในช่วง 201 ถึง 800 ***
  if (ldr_adc > 200 && ldr_adc < 800) {
    
    // ข้อ 3.3.1: ถ้าค่า LDR <= 500 ให้หมุนทวนเข็มนาฬิกา (Counter Clockwise)
    if (ldr_adc <= 500) {
      digitalWrite(IN1, LOW); 
      digitalWrite(IN2, HIGH);
      motorStatus = "Counter Clockwise";
    } 
    // ข้อ 3.3.2: ถ้าค่า LDR > 500 ให้หมุนตามเข็มนาฬิกา (Clockwise)
    else {
      digitalWrite(IN1, HIGH); 
      digitalWrite(IN2, LOW);
      motorStatus = "Clockwise";
    }
    
  } 
  // *** โจทย์ข้อ 3.4: ถ้าค่า LDR <= 200 หรือ >= 800 ให้มอเตอร์หยุดหมุน ***
  else {
    digitalWrite(IN1, LOW); 
    digitalWrite(IN2, LOW);
    motorStatus = "Stop";
  }

  // *** โจทย์ข้อ 4: ส่งข้อมูลขึ้น MQTT Dashboard ***
  client.publish(mqtt_ldr, String(ldr_adc));      // 4.1 ส่งค่าแสง
  client.publish(mqtt_status, motorStatus);       // 4.2 ส่งสถานะการหมุน
  
  delay(500); // หน่วงเวลาเพื่อให้ข้อมูลไม่ส่งถี่เกินไป
}
